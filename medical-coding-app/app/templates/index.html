<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Coding App</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container" style="max-width: 1200px; margin: 0 auto;">
        <header>
            <h1>Medical Coding Application</h1>
            <p>Enter clinical text to extract UMLS concepts.</p>
        </header>
        <section style="margin-bottom:1em;">
            <strong>What is UMLS?</strong><br>
            <span style="font-size:0.97em; color:#444;">
                The <a href="https://www.nlm.nih.gov/research/umls/" target="_blank" rel="noopener">Unified Medical Language System (UMLS)</a> is a set of biomedical vocabularies and standards developed by the U.S. National Library of Medicine. It enables interoperability between different health and biomedical information systems by providing a unified mapping of medical concepts, codes, and terms across coding systems like SNOMED CT, ICD-10, RxNorm, and more.
            </span>
        </section>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class=flashes>
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <main>
            <form method="POST" action="" id="extract-form">
                {{ form.hidden_tag() }}
                <div class="form-group">
                    <label for="similarity_cutoff">Similarity Cutoff: <span id="sim-value">{{ request.form.get('similarity_cutoff', '1.0') }}</span></label>
                    <input type="range" id="similarity_cutoff" name="similarity_cutoff" min="0" max="1" step="0.01" value="{{ request.form.get('similarity_cutoff', '1.0') }}" style="width:200px;">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="only_icd10" name="only_icd10" value="1" {% if request.form.get('only_icd10') %}checked{% endif %}>
                    <label for="only_icd10">Only if ICD-10 mapped</label>
                </div>
                <div class="form-group">
                    {{ form.clinical_note.label(class="form-label") }}<br>
                    {{ form.clinical_note(class="form-control", rows=15) }}
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 1em;">
                    {{ form.submit(class="btn btn-primary") }}
                    <span id="processing-indicator" style="display:none; text-align:center;">
                        <span class="spinner" style="display:inline-block; width:24px; height:24px; border:3px solid #ccc; border-top:3px solid #333; border-radius:50%; animation: spin 1s linear infinite; vertical-align:middle;"></span>
                        <span style="margin-left: 0.5em;">Processing text, please wait…</span>
                    </span>
                </div>
            </form>
            
            {% if codes %}
            <section class="results">
                <h2>Extracted Concepts</h2>
                    <div style="margin:0.5em 0 1em 0; display:flex; flex-wrap:wrap; gap:1.5em; align-items:center;">
                        <div style="display:flex; gap:0.75em; flex-wrap:wrap;">
                            <label><input type="checkbox" class="col-toggle" data-col="col-icd10" checked> ICD-10</label>
                            <label><input type="checkbox" class="col-toggle" data-col="col-snomed" checked> SNOMED</label>
                            <label><input type="checkbox" class="col-toggle" data-col="col-similarity" checked> Similarity</label>
                            <label><input type="checkbox" class="col-toggle" data-col="col-semtypes" checked> Semantic Types</label>
                            <label><input type="checkbox" class="col-toggle" data-col="col-cui" checked> CUI</label>
                            <label><input type="checkbox" class="col-toggle" data-col="col-term" checked> Term</label>
                        </div>
                        <div style="display:flex; gap:0.5em;">
                            <button id="export-csv" type="button">Export CSV</button>
                            <button id="export-json" type="button">Export JSON</button>
                            <button id="toggle-all-snomed" type="button">Expand All SNOMED</button>
                        </div>
                    </div>
                <table style="width:100%;">
                    <thead>
                        <tr>
                                <th class="col-icd10">ICD-10 Code(s)</th>
                                <th class="col-snomed" style="width:320px;">SNOMED Code(s)</th>
                                <th class="col-similarity">Similarity</th>
                                <th class="col-semtypes">Semantic Types</th>
                                <th class="col-cui">CUI</th>
                                <th class="col-term">Term</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if codes and codes|length > 0 %}
                        {% for code in codes %}
                        <tr>
                            <!-- ICD-10 Code(s) -->
                                <td class="col-icd10">
                                {% for icd in code.icd10_codes %}
                                    <div>{{ icd.code }}: {{ icd.desc }}</div>
                                {% endfor %}
                            </td>
                            <!-- SNOMED Code(s) -->
                                <td class="col-snomed" style="font-size: 0.92em;">
                                    {% set total = code.snomed_codes|length %}
                                    {% if total > 0 %}
                                        {% set first = code.snomed_codes[0] %}
                                        <div style="font-size:0.85em; color:#444;">{{ first.code }}: <span style="font-size:0.85em; color:#666;">{{ first.desc }}</span></div>
                                        {% if total > 1 %}
                                            <div class="snomed-extra" style="display:none; margin-top:0.4em;">
                                                {% for sc in code.snomed_codes[1:] %}
                                                    <div style="font-size:0.80em; color:#555;">{{ sc.code }}: <span style="font-size:0.80em; color:#777;">{{ sc.desc }}</span></div>
                                                {% endfor %}
                                            </div>
                                            <button type="button" class="toggle-snomed" style="margin-top:0.3em; font-size:0.70em; background:none; border:1px solid #ccc; padding:2px 6px; cursor:pointer;">More ▾</button>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            <!-- Similarity -->
                                <td class="col-similarity">{{ "%.2f"|format(code.similarity) }}</td>
                            <!-- Semantic Types -->
                                <td class="col-semtypes" style="font-size:0.85em; color:#444;">
                                {% for st in code.semtypes %}
                                    <div style="font-size:0.85em; color:#444;">
                                        <span>{{ st }}</span>
                                        <span style="font-size:0.85em; color:#888;"> — {{ semtype_map.get(st, 'Unknown') }}</span>
                                    </div>
                                {% endfor %}
                            </td>
                            <!-- CUI -->
                                <td class="col-cui" style="font-size:0.85em; color:#444;">{{ code.cui }}</td>
                            <!-- Term -->
                                <td class="col-term">{{ code.term }}</td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr><td colspan="6" style="text-align:center;">No codes found for this text.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </section>
            {% endif %}
        </main>
        
        <footer>
            <p>&copy; 2025 Medical Coding App</p>
        </footer>

        <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        </style>
        <script>
        // Similarity slider value display
        document.addEventListener('DOMContentLoaded', () => {
            const slider = document.getElementById('similarity_cutoff');
            const simValue = document.getElementById('sim-value');
            if (slider && simValue) {
                // Set initial value
                simValue.textContent = slider.value;
                slider.addEventListener('input', () => {
                    simValue.textContent = slider.value;
                });
            }

            // Show processing indicator on form submit
            const form = document.getElementById('extract-form');
            const indicator = document.getElementById('processing-indicator');
            if (form && indicator) {
                form.addEventListener('submit', () => {
                    indicator.style.display = 'block';
                });
            }

            // Make Enter (without Shift) submit the form from textarea
            const textarea = document.querySelector('textarea[name="clinical_note"]');
            const form2 = textarea?.closest('form');
            if (textarea && form2) {
                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (typeof form2.requestSubmit === 'function') {
                            form2.requestSubmit();
                        } else {
                            form2.submit();
                        }
                    }
                });
            }
        });
        </script>
        {% if codes %}
        <script>
        // Column toggle logic
        document.addEventListener('DOMContentLoaded', () => {
            const toggles = document.querySelectorAll('.col-toggle');
            toggles.forEach(cb => {
                cb.addEventListener('change', () => {
                    const cls = cb.getAttribute('data-col');
                    const cells = document.querySelectorAll('.' + cls);
                    cells.forEach(c => {
                        c.style.display = cb.checked ? '' : 'none';
                    });
                });
            });

            // Per-row SNOMED toggle
            document.querySelectorAll('.toggle-snomed').forEach(btn => {
                btn.addEventListener('click', () => {
                    const extra = btn.parentElement.querySelector('.snomed-extra');
                    if (!extra) return;
                    const expanded = extra.style.display !== 'none';
                    if (expanded) {
                        extra.style.display = 'none';
                        btn.textContent = 'More ▾';
                    } else {
                        extra.style.display = '';
                        btn.textContent = 'Less ▴';
                    }
                });
            });

            // Global expand/collapse all SNOMED
            const globalBtn = document.getElementById('toggle-all-snomed');
            if (globalBtn) {
                globalBtn.addEventListener('click', () => {
                    const extras = document.querySelectorAll('.snomed-extra');
                    if (!extras.length) return;
                    const anyHidden = Array.from(extras).some(e => e.style.display === 'none');
                    extras.forEach(e => { e.style.display = anyHidden ? '' : 'none'; });
                    document.querySelectorAll('.toggle-snomed').forEach(b => {
                        b.textContent = anyHidden ? 'Less ▴' : 'More ▾';
                    });
                    globalBtn.textContent = anyHidden ? 'Collapse All SNOMED' : 'Expand All SNOMED';
                });
            }

            // Export functions (client-side, visible columns only)
            function getVisibleData() {
                const active = Array.from(document.querySelectorAll('.col-toggle:checked')).map(cb => cb.getAttribute('data-col'));
                const headerMap = {
                    'col-icd10': 'icd10_codes',
                    'col-snomed': 'snomed_codes',
                    'col-similarity': 'similarity',
                    'col-semtypes': 'semtypes',
                    'col-cui': 'cui',
                    'col-term': 'term'
                };
                return window.__codes.map(item => {
                    const out = {};
                    active.forEach(cls => {
                        const key = headerMap[cls];
                        out[key] = item[key];
                    });
                    return out;
                });
            }

            function download(filename, text, mime) {
                const blob = new Blob([text], {type: mime});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; a.click();
                setTimeout(() => URL.revokeObjectURL(url), 2000);
            }

            document.getElementById('export-json').addEventListener('click', () => {
                const data = getVisibleData();
                download('codes.json', JSON.stringify(data, null, 2), 'application/json');
            });
            document.getElementById('export-csv').addEventListener('click', () => {
                const data = getVisibleData();
                if (!data.length) { return; }
                const headers = Object.keys(data[0]);
                const lines = [headers.join(',')];
                data.forEach(row => {
                    lines.push(headers.map(h => {
                        let val = row[h];
                        if (Array.isArray(val)) {
                            val = val.map(v => {
                                if (typeof v === 'object' && v !== null) {
                                    if ('code' in v && 'desc' in v) return `${v.code}: ${v.desc}`;
                                    return JSON.stringify(v);
                                }
                                return v;
                            }).join('|');
                        } else if (typeof val === 'object' && val !== null) {
                            val = JSON.stringify(val);
                        }
                        val = String(val).replace(/"/g,'""');
                        if (/[",\n]/.test(val)) val = '"' + val + '"';
                        return val;
                    }).join(','));
                });
                download('codes.csv', lines.join('\n'), 'text/csv');
            });
        });
        // Embed codes JSON for JS export
    window.__codes = JSON.parse(document.getElementById('codes-json').textContent);
        </script>
        {% endif %}
    {% if codes %}
    <script id="codes-json" type="application/json">{{ codes|tojson|safe }}</script>
    {% endif %}
    </div>
</body>
</html>